#!/usr/bin/expect -f

# BRLN-OS Automated LND Wallet Creation Script
# Uses expect to automate lncli create with API-generated seed
# Reads password from password.txt file for security

set timeout 60

# Get seed phrase argument
set seed_phrase [lindex $argv 0]

if {$argc < 1} {
    puts "Usage: $argv0 <seed_phrase>"
    puts "Password will be read from password.txt"
    exit 1
}

# Read password from file
set password_file "password.txt"
if {![file exists $password_file]} {
    puts "âŒ Error: password.txt file not found"
    exit 1
}

set fp [open $password_file r]
set wallet_password [string trim [read $fp]]
close $fp

if {$wallet_password eq ""} {
    puts "âŒ Error: password.txt is empty"
    exit 1
}

puts "ğŸš€ Starting automated LND wallet creation..."
puts "ğŸ” Reading password from password.txt"
puts "ğŸ”‘ Using API-generated seed"

# Start lncli create
spawn lncli create

# Handle the interactive prompts
expect {
    "Input wallet password:" {
        send "$wallet_password\r"
        exp_continue
    }
    "Confirm password:" {
        send "$wallet_password\r"
        exp_continue
    }
    "*Do you have an existing cipher seed*" {
        send "y\r"
        exp_continue
    }
    "*Enter 'y' to use an existing*" {
        send "y\r"
        exp_continue
    }
    "*Input your*word mnemonic*" {
        send "$seed_phrase\r"
        exp_continue
    }
    "*Input your cipher seed passphrase*" {
        send "\r"
        exp_continue
    }
    "*Input an optional address look-ahead*" {
        send "\r"
        exp_continue
    }
    "*successfully initialized*" {
        puts "\nâœ… LND wallet successfully created!"
        exit 0
    }
    "*Wallet unlock failed*" {
        puts "\nâŒ Wallet unlock failed"
        exit 1
    }
    timeout {
        puts "\nâŒ Timeout waiting for lncli create"
        exit 1
    }
    eof {
        puts "\nâœ… Process completed"
        exit 0
    }
}

# Wait a bit more for any final output
sleep 2
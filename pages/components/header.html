<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Header</title>
    <link rel="stylesheet" href="header.css" />
    <base href="../../" />
    <style>
      /* Previne flash de conte√∫do n√£o estilizado */
      body {
        opacity: 0;
        transition: opacity 0.1s ease-in;
      }
      body.loaded {
        opacity: 1;
      }
    </style>
  </head>
  <body>
    <header class="navbar">
      <div class="navbar-container">
        <div class="logo-section">
          <img src="pages/home/logo.png" alt="Logo da Pagcoin" class="logo" />
          <span class="logo-text">BRLN-OS</span>
        </div>
        <nav class="nav-menu">
          <div class="nav-scroll-container">
            <a
              href="#"
              class="nav-link active"
              data-page="pages/home/index.html"
              onclick="navigateTo('pages/home/index.html', this); return false;"
              >HOME</a
            >
            <a
              href="#"
              class="nav-link"
              data-page="pages/components/bitcoin/bitcoin.html"
              onclick="navigateTo('pages/components/bitcoin/bitcoin.html', this); return false;"
              >BITCOIN</a
            >
            <a
              href="#"
              class="nav-link"
              data-page="pages/components/lightning/lightning.html"
              onclick="navigateTo('pages/components/lightning/lightning.html', this); return false;"
              id="lightning-nav-link"
              >LIGHTNING<span class="notification-badge" id="lightning-notifications" style="display: none;"></span></a
            >
            <a
              href="#"
              class="nav-link"
              data-page="pages/components/elements/elements.html"
              onclick="navigateTo('pages/components/elements/elements.html', this); return false;"
              >LIQUID</a
            >
            <a
              href="#"
              class="nav-link"
              data-page="pages/components/tron/tron.html"
              onclick="navigateTo('pages/components/tron/tron.html', this); return false;"
              >TRON</a
            >
            <a
              href="#"
              class="nav-link"
              data-page="pages/components/tools/tools.html"
              onclick="navigateTo('pages/components/tools/tools.html', this); return false;"
              >TOOLS</a
            >
            <a
              href="#"
              class="nav-link"
              data-page="pages/components/config/config.html"
              onclick="navigateTo('pages/components/config/config.html', this); return false;"
              >CONFIG</a
            >
          </div>
        </nav>
        
        <!-- Controles de R√°dio -->
        <div class="radio-controls">
          <button id="radio-button" class="radio-btn" title="Play/Pause R√°dio">‚ñ∂Ô∏è</button>
          <button class="vol-control" id="vol-down" title="Diminuir Volume">‚àí</button>
          <button class="vol-control" id="vol-up" title="Aumentar Volume">+</button>
          <button id="novidades-button" class="novidades-btn" title="Sem novidades no momento">üì¢</button>
        </div>
      </div>
      
      <!-- Letreiro animado -->
      <div class="marquee">
        <div class="marquee-content">
          <a href="https://services.br-ln.com" target="_blank">Clique aqui para acessar o site da BRLN. Junte-se a n√≥s! - v1.0-beta</a>
        </div>
      </div>
    </header>

    <!-- Player de √°udio invis√≠vel -->
    <audio id="radio-player" src="https://dc1.serverse.com/proxy/dnutqhxl/stream"></audio>

    <script>
      function abrirApp(porta) {
        const ip = window.location.hostname;
        window.open(`http://${ip}:${porta}`, '_blank');
      }

      function navigateToService(porta, linkElement) {
        const ip = window.location.hostname;
        const serviceUrl = `http://${ip}:${porta}`;
        
        // Muda o conte√∫do do iframe inferior para o servi√ßo
        parent.document.getElementById("contentFrame").src = serviceUrl;

        // Atualiza classe active
        const links = document.querySelectorAll(".nav-link");
        links.forEach((link) => link.classList.remove("active"));
        linkElement.classList.add("active");

        // Armazena a URL do servi√ßo no sessionStorage
        sessionStorage.setItem("currentPage", serviceUrl);
      }

      function navigateTo(page, linkElement) {
        // Muda o conte√∫do do iframe inferior
        parent.document.getElementById("contentFrame").src = page;

        // Atualiza classe active
        const links = document.querySelectorAll(".nav-link");
        links.forEach((link) => link.classList.remove("active"));
        linkElement.classList.add("active");

        // Armazena a p√°gina atual no sessionStorage
        sessionStorage.setItem("currentPage", page);
      }

      function navigateToSection(page, sectionId, linkElement) {
        // Carrega a p√°gina
        parent.document.getElementById("contentFrame").src = page;

        // Atualiza classe active
        const links = document.querySelectorAll(".nav-link");
        links.forEach((link) => link.classList.remove("active"));
        linkElement.classList.add("active");

        // Aguarda carregar e depois faz o scroll
        setTimeout(() => {
          const contentFrame = parent.document.getElementById("contentFrame");
          const section =
            contentFrame.contentWindow.document.getElementById(sectionId);
          if (section) {
            section.scrollIntoView({ behavior: "smooth" });
          }
        }, 300);

        // Armazena a p√°gina e se√ß√£o atual
        sessionStorage.setItem("currentPage", page);
        sessionStorage.setItem("currentSection", sectionId);
      }

      // Restaura a p√°gina ativa ao carregar o header
      function initializeHeader() {
        const currentPage = sessionStorage.getItem("currentPage");
        const links = document.querySelectorAll(".nav-link");

        // Remove todas as classes active primeiro
        links.forEach((link) => link.classList.remove("active"));

        // Adiciona active ao link correto
        if (currentPage) {
          let foundActive = false;
          links.forEach((link) => {
            if (link.dataset.page === currentPage) {
              // For√ßa reflow antes de adicionar a classe
              void link.offsetHeight;
              link.classList.add("active");
              foundActive = true;
            }
          });

          // Se n√£o encontrou a p√°gina, ativa o primeiro link (IN√çCIO)
          if (!foundActive && links.length > 0) {
            void links[0].offsetHeight;
            links[0].classList.add("active");
          }
        } else {
          // Se n√£o h√° p√°gina salva, ativa o primeiro link
          if (links.length > 0) {
            void links[0].offsetHeight;
            links[0].classList.add("active");
          }
        }

        // Mostra o body ap√≥s inicializa√ß√£o
        document.body.classList.add("loaded");
      }

      // Executa quando o DOM estiver pronto
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initializeHeader);
      } else {
        // Se o DOM j√° est√° pronto, executa imediatamente
        initializeHeader();
      }

      // ========== R√ÅDIO CONTROLS ==========
      const radioPlayer = document.getElementById('radio-player');
      const radioButton = document.getElementById('radio-button');
      const volDownBtn = document.getElementById('vol-down');
      const volUpBtn = document.getElementById('vol-up');
      const novidadesBtn = document.getElementById('novidades-button');

      let isPlaying = false;
      let currentVolume = 0.5;

      // Define volume inicial
      radioPlayer.volume = currentVolume;

      // Toggle Play/Pause
      radioButton.addEventListener('click', () => {
        if (isPlaying) {
          radioPlayer.pause();
          radioButton.textContent = '‚ñ∂Ô∏è';
          radioButton.title = 'Play R√°dio';
        } else {
          radioPlayer.play();
          radioButton.textContent = '‚è∏Ô∏è';
          radioButton.title = 'Pause R√°dio';
        }
        isPlaying = !isPlaying;
      });

      // Diminuir volume
      volDownBtn.addEventListener('click', () => {
        currentVolume = Math.max(0, currentVolume - 0.1);
        radioPlayer.volume = currentVolume;
      });

      // Aumentar volume
      volUpBtn.addEventListener('click', () => {
        currentVolume = Math.min(1, currentVolume + 0.1);
        radioPlayer.volume = currentVolume;
      });

      // Bot√£o de novidades (exemplo)
      novidadesBtn.addEventListener('click', () => {
        alert('Sem novidades no momento!');
      });

      // === SISTEMA DE NOTIFICA√á√ïES LIGHTNING ===
      
      // Fun√ß√£o para verificar notifica√ß√µes Lightning
      async function checkLightningNotifications() {
        try {
          const response = await fetch('/api/v1/lightning/chat/notifications');
          if (!response.ok) return;
          
          const data = await response.json();
          const badge = document.getElementById('lightning-notifications');
          
          if (data.status === 'success' && data.unread_count > 0) {
            badge.textContent = data.unread_count > 9 ? '9+' : data.unread_count;
            badge.style.display = 'flex';
          } else {
            badge.style.display = 'none';
          }
        } catch (error) {
          console.log('Erro ao verificar notifica√ß√µes Lightning:', error);
        }
      }
      
      // Fun√ß√£o chamada quando h√° nova mensagem Lightning (chamada pelo iframe)
      function notifyLightningMessage() {
        checkLightningNotifications();
      }
      
      // Fun√ß√£o para resetar notifica√ß√µes quando usu√°rio visita Lightning
      function resetLightningNotifications() {
        fetch('/api/v1/lightning/chat/notifications', {
          method: 'POST'
        }).then(() => {
          checkLightningNotifications();
        }).catch(err => {
          console.log('Erro ao resetar notifica√ß√µes:', err);
        });
      }
      
      // Override da fun√ß√£o navigateTo para detectar quando visita Lightning
      const originalNavigateTo = window.navigateTo;
      window.navigateTo = function(page, linkElement) {
        // Se est√° navegando para Lightning, resetar notifica√ß√µes
        if (page === 'pages/components/lightning/lightning.html') {
          resetLightningNotifications();
        }
        
        // Chamar fun√ß√£o original
        return originalNavigateTo.call(this, page, linkElement);
      };
      
      // Verificar notifica√ß√µes a cada 10 segundos
      checkLightningNotifications();
      setInterval(checkLightningNotifications, 10000);
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BRLN-OS - Bitcoin for the People</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: Arial, sans-serif;
        overflow: hidden;
        height: 100vh;
      }

      .container {
        display: flex;
        flex-direction: column;
        height: 100vh;
      }

      .header-frame {
        height: 80px;
        border: none;
        border-bottom: 2px solid #ccc;
        flex-shrink: 0;
      }

      .content-frame {
        flex: 1;
        border: none;
        width: 100%;
        height: calc(100vh - 80px);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- IFRAME SUPERIOR: Cabe√ßalho fixo -->
      <iframe
        id="headerFrame"
        class="header-frame"
        src="pages/components/header.html"
        scrolling="no"
      ></iframe>

      <!-- IFRAME INFERIOR: Conte√∫do din√¢mico -->
      <iframe
        id="contentFrame"
        class="content-frame"
        src="pages/home/index.html"
        name="contentFrame"
      ></iframe>
    </div>

    <script>
      // ============================================
      // WALLET STATUS MANAGEMENT
      // ============================================
      class MainWalletManager {
        constructor() {
          this.apiBase = '/api/v1';
          this.isCheckingWallet = false;
          this.notificationQueue = [];
          this.currentNotification = null;
          this.isProcessingNotifications = false;
        }

        /**
         * Check if system wallet is configured
         */
        async checkSystemWallet() {
          if (this.isCheckingWallet) return;
          this.isCheckingWallet = true;

          try {
            console.log('Main: Checking system wallet configuration...');
            const response = await fetch(`${this.apiBase}/wallet/system-default`);
            const data = await response.json();
            
            if (response.ok && data.status === 'success') {
              console.log('Main: System wallet found:', data.wallet_id);
              return {
                hasWallet: true,
                walletId: data.wallet_id,
                metadata: data.metadata
              };
            } else {
              console.log('Main: No system wallet configured');
              return {
                hasWallet: false,
                error: data.error
              };
            }
          } catch (error) {
            console.error('Main: Error checking wallet status:', error);
            return {
              hasWallet: false,
              error: error.message
            };
          } finally {
            this.isCheckingWallet = false;
          }
        }

        /**
         * Show wallet status notification with queue management
         */
        showWalletNotification(message, isSuccess = true, timeout = null) {
          // Determine timeout based on message type
          let notificationTimeout = timeout;
          if (!notificationTimeout) {
            if (message.includes('Inicializando sistema')) {
              notificationTimeout = 2000; // 2 seconds for initialization messages
            } else {
              notificationTimeout = 3000; // 3 seconds for other messages
            }
          }
          
          // Add to queue
          this.notificationQueue.push({ message, isSuccess, timeout: notificationTimeout });
          this.processNotificationQueue();
        }

        /**
         * Process notification queue to ensure only one notification at a time
         */
        async processNotificationQueue() {
          if (this.isProcessingNotifications || this.notificationQueue.length === 0) {
            return;
          }

          this.isProcessingNotifications = true;

          // Clear any existing notification immediately
          if (this.currentNotification) {
            this.clearCurrentNotification();
          }

          // Process the most recent notification (clear queue of duplicates)
          const notification = this.notificationQueue.pop();
          this.notificationQueue = []; // Clear entire queue, only show latest

          this.showSingleNotification(notification.message, notification.isSuccess, notification.timeout);
        }

        /**
         * Show a single notification
         */
        showSingleNotification(message, isSuccess, timeout = 3000) {
          // Ensure no existing notifications
          this.clearAllNotifications();

          const notification = document.createElement('div');
          const notificationId = `wallet-notification-${Date.now()}`;
          notification.id = notificationId;
          notification.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: ${isSuccess ? '#28a745' : '#dc3545'};
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            z-index: 10000;
            font-family: Arial, sans-serif;
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border: 2px solid ${isSuccess ? '#1e7e34' : '#c82333'};
            max-width: 90%;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
          `;
          notification.textContent = message;
          
          document.body.appendChild(notification);
          this.currentNotification = notification;

          // Fade in
          requestAnimationFrame(() => {
            notification.style.opacity = '1';
          });
          
          // Auto remove after specified timeout
          this.currentNotification.timeoutId = setTimeout(() => {
            this.clearCurrentNotification();
            this.isProcessingNotifications = false;
            // Process any queued notifications
            this.processNotificationQueue();
          }, timeout);
        }

        /**
         * Clear current notification with fade out
         */
        clearCurrentNotification() {
          if (!this.currentNotification) return;

          const notification = this.currentNotification;
          if (notification.timeoutId) {
            clearTimeout(notification.timeoutId);
          }

          notification.style.opacity = '0';
          setTimeout(() => {
            if (notification.parentNode) {
              notification.remove();
            }
          }, 300);

          this.currentNotification = null;
        }

        /**
         * Clear all notifications forcefully
         */
        clearAllNotifications() {
          const notifications = document.querySelectorAll('[id^="wallet-notification"]');
          notifications.forEach(notification => {
            if (notification.parentNode) {
              notification.remove();
            }
          });
          this.currentNotification = null;
        }

        /**
         * Redirect to wallet creation page
         */
        redirectToWalletPage() {
          console.log('Main: Redirecting to wallet configuration...');
          this.showWalletNotification('Redirecionando para configura√ß√£o de wallet...', false);
          
          setTimeout(() => {
            document.getElementById('contentFrame').src = 'pages/components/wallet/wallet.html';
            sessionStorage.setItem('currentPage', 'pages/components/wallet/wallet.html');
            sessionStorage.setItem('requireWalletSetup', 'true');
          }, 1500);
        }

        /**
         * Initialize system with configured wallet
         */
        async initializeWithWallet(walletData) {
          // Set flag to prevent index.js from also initializing
          window.walletInitializationInProgress = true;
          
          // Show loading notification with shorter timeout
          this.showWalletNotification(`Inicializando sistema com wallet: ${walletData.walletId}`);
          
          try {
            // Try to load the wallet with password retry logic
            const response = await this.loadWalletWithRetry(walletData.walletId);
            
            if (response.success) {
              // Clear any existing notifications first, then show success
              this.clearAllNotifications();
              this.showWalletNotification('Sistema wallet inicializado com sucesso!');
              console.log('Main: System wallet initialized successfully');
              
              // Continue with normal app loading
              this.loadHomePage();
            } else {
              console.error('Main: Failed to initialize wallet:', response.error);
              this.clearAllNotifications();
              this.showWalletNotification('Erro ao inicializar wallet do sistema', false);
              this.redirectToWalletPage();
            }
          } catch (error) {
            console.error('Main: Wallet initialization error:', error);
            this.showWalletNotification('Erro de conex√£o com API', false);
            this.redirectToWalletPage();
          }
        }

        /**
         * Load wallet with password retry logic
         */
        async loadWalletWithRetry(walletId, maxRetries = 3) {
          let attempt = 0;
          
          while (attempt < maxRetries) {
            try {
              // Always prompt for password since our wallets are encrypted
              const password = await this.promptForPassword(walletId, attempt + 1);
              
              const response = await fetch(`${this.apiBase}/wallet/load`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  wallet_id: walletId,
                  password: password
                })
              });
              
              const data = await response.json();
              
              if (response.ok) {
                return { success: true, data: data };
              } else if (data.error && (data.error.includes('password') || data.error.includes('Invalid password'))) {
                console.log(`Password attempt ${attempt + 1} failed for wallet ${walletId}`);
                attempt++;
                if (attempt >= maxRetries) {
                  return { success: false, error: 'M√°ximo de tentativas de senha excedido' };
                }
                // Continue to next attempt
              } else {
                return { success: false, error: data.error };
              }
            } catch (error) {
              if (error.message === 'Password prompt cancelled') {
                return { success: false, error: 'Opera√ß√£o cancelada pelo usu√°rio' };
              }
              return { success: false, error: error.message };
            }
          }
          
          return { success: false, error: 'Falha ap√≥s m√∫ltiplas tentativas' };
        }

        /**
         * Prompt user for wallet password
         */
        async promptForPassword(walletId, attempt = 1) {
          return new Promise((resolve, reject) => {
            // Create modal for password input
            const modal = document.createElement('div');
            modal.id = 'password-modal';
            modal.style.cssText = `
              position: fixed;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background: rgba(0, 0, 0, 0.8);
              display: flex;
              justify-content: center;
              align-items: center;
              z-index: 20000;
              font-family: Arial, sans-serif;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
              background: white;
              border-radius: 10px;
              padding: 30px;
              max-width: 400px;
              width: 90%;
              box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
              text-align: center;
              border: 3px solid #007bff;
            `;
            
            modalContent.innerHTML = `
              <h3 style="margin-bottom: 20px; color: #007bff; font-size: 24px;">üîê Wallet Protegida</h3>
              <p style="margin-bottom: 20px; color: #666; font-size: 16px;">A wallet <strong>${walletId}</strong> est√° encriptada. Desbloqueie-a ou escolha outra carteira.</p>
              ${attempt > 1 ? `<p style="color: #dc3545; margin-bottom: 15px; font-weight: bold;">‚ùå Senha incorreta (tentativa ${attempt}/3)</p>` : ''}
              <input type="password" id="wallet-password" placeholder="Digite a senha da wallet" 
                style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 20px; font-size: 16px; box-sizing: border-box;" autofocus>
              <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button id="unlock-btn" style="background: #28a745; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: bold;">üîì Desbloquear</button>
                <button id="wallet-select-btn" style="background: #007bff; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: bold;"> Wallets ‚û°Ô∏è</button>
                <button id="cancel-btn" style="background: #dc3545; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: bold;">‚ùå Cancelar</button>
              </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            const passwordInput = modal.querySelector('#wallet-password');
            const unlockBtn = modal.querySelector('#unlock-btn');
            const walletSelectBtn = modal.querySelector('#wallet-select-btn');
            const cancelBtn = modal.querySelector('#cancel-btn');
            
            const cleanup = () => {
              if (modal.parentNode) {
                modal.parentNode.removeChild(modal);
              }
            };
            
            unlockBtn.onclick = () => {
              const password = passwordInput.value.trim();
              if (password) {
                cleanup();
                resolve(password);
              } else {
                passwordInput.style.borderColor = '#dc3545';
                passwordInput.placeholder = 'Senha √© obrigat√≥ria';
                passwordInput.focus();
              }
            };
            
            walletSelectBtn.onclick = () => {
              cleanup();
              // Redirect to wallet selection page
              document.getElementById('contentFrame').src = 'pages/components/wallet/wallet.html';
              sessionStorage.setItem('currentPage', 'pages/components/wallet/wallet.html');
              sessionStorage.setItem('requireWalletSetup', 'true');
              reject(new Error('User chose to select different wallet'));
            };
            
            cancelBtn.onclick = () => {
              cleanup();
              reject(new Error('Password prompt cancelled'));
            };
            
            passwordInput.onkeypress = (e) => {
              if (e.key === 'Enter') {
                unlockBtn.click();
              }
              // Reset border color on typing
              if (passwordInput.style.borderColor === 'rgb(220, 53, 69)') {
                passwordInput.style.borderColor = '#ddd';
                passwordInput.placeholder = 'Digite a senha da wallet';
              }
            };
            
            // Focus on input after modal is rendered
            setTimeout(() => passwordInput.focus(), 150);
          });
        }

        /**
         * Load home page normally
         */
        loadHomePage() {
          const contentFrame = document.getElementById('contentFrame');
          contentFrame.src = 'pages/home/index.html';
          sessionStorage.setItem('currentPage', 'pages/home/index.html');
          sessionStorage.removeItem('requireWalletSetup');
        }

        /**
         * Main wallet check and initialization
         */
        async performWalletCheck() {
          // Check if user wants to bypass default wallet (useful for troubleshooting)
          const bypassDefault = sessionStorage.getItem('bypassDefaultWallet');
          if (bypassDefault) {
            console.log('Main: Bypassing default wallet check');
            sessionStorage.removeItem('bypassDefaultWallet');
            this.redirectToWalletPage();
            return;
          }

          // Check if we just came from wallet setup
          const justSetup = sessionStorage.getItem('walletJustConfigured');
          if (justSetup) {
            sessionStorage.removeItem('walletJustConfigured');
            this.loadHomePage();
            return;
          }

          // Check for system wallet
          const walletStatus = await this.checkSystemWallet();
          
          if (walletStatus.hasWallet) {
            console.log('Main: Found system wallet:', walletStatus.walletId);
            
            // Check if wallet requires password
            if (walletStatus.metadata && walletStatus.metadata.has_password) {
              console.log('Main: System wallet requires password - redirecting to wallet page');
              this.showWalletNotification('Sistema wallet requer senha - carregando p√°gina de autentica√ß√£o...', false);
              this.redirectToWalletPage();
              return;
            }
            
            // Found configured wallet - initialize system
            await this.initializeWithWallet(walletStatus);
          } else {
            // No wallet configured - redirect to setup
            this.redirectToWalletPage();
          }
        }
      }

      // ============================================
      // MAIN INITIALIZATION
      // ============================================
      window.addEventListener("DOMContentLoaded", async () => {
        // Initialize wallet manager
        const walletManager = new MainWalletManager();
        
        // Make it globally accessible
        window.mainWalletManager = walletManager;
        
        // Perform wallet check and initialization
        await walletManager.performWalletCheck();
        
        // Set up navigation function for external calls
        window.navigateToPage = function(page) {
          document.getElementById("contentFrame").src = page;
          sessionStorage.setItem("currentPage", page);
        };
        
        // Listen for wallet configuration completion
        window.addEventListener('message', function(event) {
          if (event.data && event.data.type === 'WALLET_CONFIGURED') {
            console.log('Main: Received wallet configuration completion signal');
            sessionStorage.setItem('walletJustConfigured', 'true');
            walletManager.loadHomePage();
          }
        });
        
        console.log('Main: Application initialized with wallet management');
      });
    </script>
  </body>
</html>

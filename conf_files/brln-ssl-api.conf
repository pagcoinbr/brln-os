<VirtualHost *:443>
    ServerAdmin webmaster@localhost
    DocumentRoot /var/www/html

    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/ssl-cert-snakeoil.pem
    SSLCertificateKeyFile /etc/ssl/private/ssl-cert-snakeoil.key

    # Security Headers
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    Header always set X-Frame-Options SAMEORIGIN
    Header always set X-Content-Type-Options nosniff
    Header always set X-XSS-Protection "1; mode=block"

    # API Proxy Configuration for BRLN-OS
    ProxyPreserveHost On
    ProxyRequests Off

    # CORS Headers for API
    <Location /api/>
        Header always set Access-Control-Allow-Origin "*"
        Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
        Header always set Access-Control-Max-Age "3600"
    </Location>

    # API Endpoints - Proxy to port 2121
    ProxyPass /api/ http://localhost:2121/api/
    ProxyPassReverse /api/ http://localhost:2121/api/

    # WebSocket support for real-time features
    RewriteEngine on
    RewriteCond %{HTTP:UPGRADE} websocket [NC]
    RewriteCond %{HTTP:CONNECTION} upgrade [NC]
    RewriteRule ^/api/(.*) "ws://localhost:2121/api/$1" [P,L]
    
    # Proxy WebSocket connections
    ProxyPass /ws/ ws://localhost:2121/ws/
    ProxyPassReverse /ws/ ws://localhost:2121/ws/

    # Additional proxy for potential services
    ProxyPass /lightning/ http://localhost:5000/
    ProxyPassReverse /lightning/ http://localhost:5000/

    # Terminal Web Proxy - Gotty on port 3131
    <Location "/terminal/">
        ProxyPass http://localhost:3131/
        ProxyPassReverse http://localhost:3131/
        Header always unset X-Frame-Options
        Header always set X-Frame-Options "SAMEORIGIN"
    </Location>
    
    # Alias for gotty-fullauto (same as terminal)
    <Location "/gotty-fullauto">
        ProxyPass http://localhost:3131/
        ProxyPassReverse http://localhost:3131/
        Header always unset X-Frame-Options
        Header always set X-Frame-Options "SAMEORIGIN"
    </Location>
    
    # WebSocket support for terminal
    RewriteCond %{HTTP:UPGRADE} websocket [NC]
    RewriteCond %{HTTP:CONNECTION} upgrade [NC]
    RewriteRule ^/terminal/(.*) "ws://localhost:3131/$1" [P,L]
    
    # WebSocket support for gotty-fullauto
    RewriteCond %{HTTP:UPGRADE} websocket [NC]
    RewriteCond %{HTTP:CONNECTION} upgrade [NC]
    RewriteRule ^/gotty-fullauto/(.*) "ws://localhost:3131/$1" [P,L]

    # Error and Access Logs
    ErrorLog ${APACHE_LOG_DIR}/brln_error.log
    CustomLog ${APACHE_LOG_DIR}/brln_access.log combined
</VirtualHost>
